<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VunaVerify - Interactive Map</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            height: 100vh;
            width: 100%;
        }

        /* Popup Styles */
        .project-popup .leaflet-popup-content-wrapper {
            border-radius: 8px;
            padding: 0;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .project-popup .leaflet-popup-content {
            margin: 0;
            width: 280px !important;
        }

        .popup-header {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 12px 16px;
            font-family: 'Segoe UI', sans-serif;
        }

        .popup-header h3 {
            margin: 0;
            font-size: 16px;
        }

        .popup-body {
            padding: 16px;
            font-family: 'Segoe UI', sans-serif;
            color: #333;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .stat-label {
            color: #666;
        }

        .stat-value {
            font-weight: 600;
            color: #111;
        }

        .revenue-value {
            color: #10b981;
        }

        /* Legend Style */
        .legend {
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            font-family: 'Segoe UI', sans-serif;
            line-height: 18px;
            color: #555;
            min-width: 150px;
        }

        .legend h4 {
            margin: 0 0 10px;
            color: #333;
            font-size: 14px;
        }

        .legend i {
            width: 14px;
            height: 14px;
            float: left;
            margin-right: 8px;
            opacity: 0.9;
            border-radius: 50%;
        }

        .legend-row {
            clear: both;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
        }
    </style>
</head>

<body>

    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // 1. Initialize Map centered on Kenya
        var map = L.map('map').setView([-0.50, 37.0], 6.5); // Better Center for Kenya

        // 2. Add Esri Satellite Tiles (The "Google Earth" look)
        var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri',
            maxZoom: 17
        }).addTo(map);

        // Add Dark Map Labels/Borders
        var labelsLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', {
            attribution: '&copy;OpenStreetMap, &copy;CartoDB',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        // 3. Load Kenya Boundary (GeoJSON)
        // Using a reliable CDN for country borders
        fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries/KEN.geo.json')
            .then(res => res.json())
            .then(data => {
                L.geoJSON(data, {
                    style: {
                        color: "#fff",
                        weight: 2,
                        opacity: 0.6,
                        fillOpacity: 0.0 // Transparent fill
                    }
                }).addTo(map);
            });

        // 4. Color Grading Logic
        function getColor(flux) {
            return flux > 0.07 ? '#10b981' : // High (Green)
                flux > 0.04 ? '#a3e635' : // Medium (Yellow-Green)
                    flux > 0.02 ? '#facc15' : // Low-Medium (Yellow)
                        '#fb923c';  // Low (Orange)
        }

        // 5. Add Legend
        var legend = L.control({ position: 'bottomright' });
        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'legend');
            div.innerHTML += '<h4>Carbon Flux Intensity</h4>';
            div.innerHTML += '<div class="legend-row"><i style="background:#10b981"></i> High (>0.07)</div>';
            div.innerHTML += '<div class="legend-row"><i style="background:#a3e635"></i> Good (0.04 - 0.07)</div>';
            div.innerHTML += '<div class="legend-row"><i style="background:#facc15"></i> Moderate (0.02 - 0.04)</div>';
            div.innerHTML += '<div class="legend-row"><i style="background:#fb923c"></i> Low (<0.02)</div>';
            return div;
        };
        legend.addTo(map);

        // 6. Fetch Projects and Overlay
        fetch('/api/projects/')
            .then(response => response.json())
            .then(data => {
                data.forEach(project => {
                    if (project.geojson_boundary) {
                        var color = getColor(project.cached_flux || 0);
                        var geojson = JSON.parse(project.geojson_boundary);

                        L.geoJSON(geojson, {
                            style: {
                                color: color,
                                weight: 3,
                                opacity: 1,
                                fillOpacity: 0.4,
                                fillColor: color
                            },
                            onEachFeature: function (feature, layer) {
                                // 1. Add Tooltip on Hover
                                layer.bindTooltip(`<strong>${project.name}</strong>`, {
                                    permanent: false,
                                    direction: 'top',
                                    opacity: 0.9
                                });

                                // 2. Add Hover Highlight Style
                                layer.on({
                                    mouseover: function (e) {
                                        var l = e.target;
                                        l.setStyle({
                                            weight: 5,
                                            color: '#fff',
                                            dashArray: '',
                                            fillOpacity: 0.7
                                        });
                                        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                                            l.bringToFront();
                                        }
                                    },
                                    mouseout: function (e) {
                                        // Reset style logic 
                                        // We need the original color, luckily we have it in closure 'color'
                                        var l = e.target;
                                        l.setStyle({
                                            weight: 3,
                                            color: color,
                                            fillOpacity: 0.4
                                        });
                                    }
                                });

                                // 3. Add Click Popup (Detailed Data)
                                var popupContent = `
                                    <div class="popup-header" style="background:${color}">
                                        <h3>${project.name}</h3>
                                    </div>
                                    <div class="popup-body">
                                        <div class="stat-row">
                                            <span class="stat-label">Carbon Flux:</span>
                                            <span class="stat-value" style="color:${color}">${project.cached_flux || '0.000'}</span>
                                        </div>
                                        <div class="stat-row">
                                            <span class="stat-label">CO2 Seq. / ha:</span>
                                            <span class="stat-value">${project.cached_co2 || '0'} tonnes/yr</span>
                                        </div>
                                        <hr style="border:0; border-top:1px solid #eee; margin: 10px 0;">
                                        <div class="stat-row">
                                            <span class="stat-label">Est. Revenue / ha:</span>
                                            <span class="stat-value revenue-value">$${project.cached_revenue || '0.00'}</span>
                                        </div>
                                    </div>
                                `;
                                layer.bindPopup(popupContent, { className: 'project-popup', closeButton: false });
                            }
                        }).addTo(map);
                    } else if (project.latitude && project.longitude) {
                        // Fallback to Circle if no boundary
                        var color = getColor(project.cached_flux || 0);
                        var popupContent = `
                            <div class="popup-header" style="background:${color}">
                                <h3>${project.name}</h3>
                            </div>
                            <div class="popup-body">
                                <div class="stat-row">
                                    <span class="stat-label">Carbon Flux:</span>
                                    <span class="stat-value" style="color:${color}">${project.cached_flux || 'N/A'}</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">CO2 Sequestration:</span>
                                    <span class="stat-value">${project.cached_co2 || '0'} tonnes/yr</span>
                                </div>
                                <hr style="border:0; border-top:1px solid #eee; margin: 10px 0;">
                                <div class="stat-row">
                                    <span class="stat-label">Est. Revenue:</span>
                                    <span class="stat-value revenue-value">$${project.cached_revenue || '0.00'}</span>
                                </div>
                            </div>
                        `;
                        // Shorthand for simple circle
                        L.circleMarker([project.latitude, project.longitude], {
                            radius: 10, fillColor: color, color: "#fff", weight: 2, fillOpacity: 0.8
                        })
                            .addTo(map)
                            .bindPopup(popupContent, {
                                className: 'project-popup',
                                closeButton: false
                            });
                    }
                });
            })
            .catch(error => console.error('Error fetching projects:', error));
    </script>
</body>

</html>